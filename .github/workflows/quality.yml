name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        run: uv python install 3.12
      
      - name: Install dependencies
        run: uv sync --dev
      
      - name: Check code formatting with ruff
        run: |
          echo "## ðŸ”§ Code Formatting Check" >> $GITHUB_STEP_SUMMARY
          uv run ruff format --check . || {
            echo "âŒ Code formatting issues found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`uv run ruff format .\` to fix formatting issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… Code formatting is correct" >> $GITHUB_STEP_SUMMARY
      
      - name: Run linting with ruff
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§¹ Linting Check" >> $GITHUB_STEP_SUMMARY
          uv run ruff check . || {
            echo "âŒ Linting issues found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`uv run ruff check --fix .\` to fix auto-fixable issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… No linting issues found" >> $GITHUB_STEP_SUMMARY
      
      - name: Type checking with mypy
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Type Checking" >> $GITHUB_STEP_SUMMARY
          uv run mypy src/ || {
            echo "âŒ Type checking failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          }
          echo "âœ… Type checking passed" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true  # Don't fail the build on type errors for now
      
      - name: Security check with bandit
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”’ Security Check" >> $GITHUB_STEP_SUMMARY
          uv run bandit -r src/ -f json | jq -r '.results[] | "âš ï¸  " + .filename + ":" + (.line_number|tostring) + " - " + .test_name + ": " + .issue_text' >> $GITHUB_STEP_SUMMARY || true
          uv run bandit -r src/ || {
            echo "âš ï¸  Security issues found - please review" >> $GITHUB_STEP_SUMMARY
            exit 0  # Don't fail on security warnings, just report them
          }
          echo "âœ… No security issues found" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true